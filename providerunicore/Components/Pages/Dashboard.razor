@page "/dashboard/"
@using unicoreprovider.Models 
@using unicoreprovider.Services
@using unicoreprovider.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Threading
@implements IDisposable
@inject VmService VmService
@rendermode RenderMode.InteractiveServer

<PageTitle>UniCore Provider Dashboard</PageTitle>

<style>
    body {
        background-color: #121212; /* Very dark background for the whole page */
        color: #e0e0e0;
    }
    .dashboard-card {
        background-color: #1a1a1a;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
    }
    .table-dark-custom {
        color: #e0e0e0;
        --bs-table-hover-bg: #2a2a2a;
        --bs-table-bg: transparent;
        --bs-table-border-color: #333;
    }
    .text-muted-light {
        color: #a0a0a0 !important;
    }
    /* Custom Scrollbar for table if needed */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-white">Provider Dashboard</h1>
            <p class="text-muted-light">Real-time resource monitoring.</p>
        </div>
    </div>

    <div class="row mb-4 g-3">
        @{
            var activeVms = Vms.Where(v => v.Status == "Running").ToList();
            var avgCpu = activeVms.Any() ? activeVms.Average(v => v.CurrentCpuUsage) : 0;
            var avgGpu = activeVms.Any() ? activeVms.Average(v => v.CurrentGpuUsage) : 0;
            var avgRam = activeVms.Any() ? activeVms.Average(v => v.CurrentRamUsage) : 0;
            
            var demoVm = activeVms.FirstOrDefault() ?? new VirtualMachine();
        }

        <div class="col-md-4">
            <MetricCard Title="CPU" 
                        Value="@avgCpu.ToString("0")" 
                        Percent="@((double)avgCpu)"
                        Color="#3b82f6" 
                        DataPoints="@demoVm.CpuHistory" /> 
        </div>
        <div class="col-md-4">
            <MetricCard Title="GPU" 
                        Value="@avgGpu.ToString("0")" 
                        Percent="@((double)avgGpu)"
                        Color="#10b981" 
                        DataPoints="@demoVm.GpuHistory" />
        </div>
        <div class="col-md-4">
            <MetricCard Title="RAM" 
                        Value="@((activeVms.Sum(v => v.RamGB) * (avgRam/100)).ToString("0.0"))" 
                        Unit="GB"
                        Percent="@((double)avgRam)"
                        Color="#a855f7" 
                        DataPoints="@demoVm.RamHistory" />
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <ResourceSlider Title="CPU CORE LIMIT" 
                            Unit="percent" 
                            Max="100"
                            MinLimit="20" 
                            Color="#00E5FF" 
                            IconClass="bi bi-cpu"
                            @bind-Value="CpuLimit" />
        </div>
        <div class="col-md-6">
            <ResourceSlider Title="RAM ALLOCATION" 
                            Unit="gigabytes" 
                            Max="128"
                            MinLimit="20" 
                            Color="#D500F9" 
                            IconClass="bi bi-hdd-rack"
                            @bind-Value="RamLimit" />
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <VmList Vms="@Vms" />
        </div>
    </div>
</div>

@code {
    private List<VirtualMachine> Vms { get; set; } = new();
    private PeriodicTimer? _timer;
    private CancellationTokenSource _cts = new();

    // New Fields for Slider Binding
    private double CpuLimit { get; set; } = 55;
    private double RamLimit { get; set; } = 80;

    protected override async Task OnInitializedAsync()
    {
        // 1. Load initial data
        await RefreshData();
        // 2. Start background timer
        _ = StartTimerAsync(); 
    }

    private async Task StartTimerAsync()
    {
        // Ticks every 100ms for smooth updates
        _timer = new PeriodicTimer(TimeSpan.FromMilliseconds(500)); // Changed to 500ms for reasonable load

        try
        {
            while (await _timer.WaitForNextTickAsync(_cts.Token))
            {
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException) { }
    }

    private async Task RefreshData()
    {
        Vms = await VmService.GetMyVmsAsync();
    }

    private void ToggleVm(VirtualMachine vm)
    {
        if (vm.Status == "Running")
        {
            vm.Status = "Stopped";
            vm.CurrentCpuUsage = 0;
            vm.CurrentGpuUsage = 0;
            vm.CurrentRamUsage = 0;
        }
        else
        {
            vm.Status = "Running";
            vm.CurrentCpuUsage = 10;
            vm.CurrentRamUsage = 20;
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _timer?.Dispose();
        _cts.Dispose();
    }
}