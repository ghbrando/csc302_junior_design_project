@page "/dashboard/"
@using unicoreprovider.Models 
@using unicoreprovider.Services
@using unicoreprovider.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Threading
@implements IDisposable
@inject VmService VmService
@rendermode RenderMode.InteractiveServer

<PageTitle>UniCore Provider Dashboard</PageTitle>

<style>
    body {
        background-color: #121212; /* Very dark background for the whole page */
        color: #e0e0e0;
    }
    .dashboard-card {
        background-color: #1a1a1a;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: none;
    }
    .table-dark-custom {
        color: #e0e0e0;
        --bs-table-hover-bg: #2a2a2a;
        --bs-table-bg: transparent;
        --bs-table-border-color: #333;
    }
    .text-muted-light {
        color: #a0a0a0 !important;
    }
    /* Custom Scrollbar for table if needed */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1a1a1a; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-white">Provider Dashboard</h1>
            <p class="text-muted-light">Real-time resource monitoring.</p>
        </div>
    </div>

    <div class="row mb-4 g-3">
        @{
            var activeVms = Vms.Where(v => v.Status == "Running").ToList();
            var avgCpu = activeVms.Any() ? activeVms.Average(v => v.CurrentCpuUsage) : 0;
            var avgGpu = activeVms.Any() ? activeVms.Average(v => v.CurrentGpuUsage) : 0;
            var avgRam = activeVms.Any() ? activeVms.Average(v => v.CurrentRamUsage) : 0;
            
            var demoVm = activeVms.FirstOrDefault() ?? new VirtualMachine();
        }

        <div class="col-md-4">
            <MetricCard Title="CPU" 
                        Value="@avgCpu.ToString("0")" 
                        Percent="@((double)avgCpu)"
                        Color="#3b82f6" 
                        DataPoints="@demoVm.CpuHistory" /> 
        </div>
        <div class="col-md-4">
            <MetricCard Title="GPU" 
                        Value="@avgGpu.ToString("0")" 
                        Percent="@((double)avgGpu)"
                        Color="#10b981" 
                        DataPoints="@demoVm.GpuHistory" />
        </div>
        <div class="col-md-4">
            <MetricCard Title="RAM" 
                        Value="@((activeVms.Sum(v => v.RamGB) * (avgRam/100)).ToString("0.0"))" 
                        Unit="GB"
                        Percent="@((double)avgRam)"
                        Color="#a855f7" 
                        DataPoints="@demoVm.RamHistory" />
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-6">
            <ResourceSlider Title="CPU CORE LIMIT" 
                            Unit="percent" 
                            Max="100"
                            MinLimit="20" 
                            Color="#00E5FF" 
                            IconClass="bi bi-cpu"
                            @bind-Value="CpuLimit" />
        </div>
        <div class="col-md-6">
            <ResourceSlider Title="RAM ALLOCATION" 
                            Unit="gigabytes" 
                            Max="128"
                            MinLimit="20" 
                            Color="#D500F9" 
                            IconClass="bi bi-hdd-rack"
                            @bind-Value="RamLimit" />
        </div>
    </div>

    <div class="card dashboard-card">
        <div class="card-header border-0 py-3" style="background-color: transparent;">
            <h5 class="mb-0 fw-bold text-white">My Machines</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-dark-custom table-hover align-middle mb-0">
                <thead style="background-color: #252525; border-bottom: 1px solid #333;">
                    <tr>
                        <th class="ps-4 py-3" style="width: 20%;">Machine</th>
                        <th style="width: 10%;">Status</th>
                        <th style="width: 40%;">Live Resources</th>
                        <th style="width: 15%;">Earnings</th>
                        <th class="text-end pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var vm in Vms)
                    {
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-white">@vm.Name</div>
                                <div class="small text-muted-light">@vm.CpuCores Cores / @vm.RamGB GB</div>
                            </td>
                            <td>
                                @if (vm.Status == "Running")
                                {
                                    <span class="badge bg-success bg-opacity-75 rounded-pill">Running</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary bg-opacity-50 rounded-pill">Stopped</span>
                                }
                            </td>
                            <td>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="small text-muted-light me-2" style="width: 30px;">CPU</span>
                                    <div class="progress flex-grow-1" style="height: 4px; background-color: #333;">
                                        <div class="progress-bar bg-primary" style="width: @vm.CurrentCpuUsage%"></div>
                                    </div>
                                    <span class="small ms-2 text-white" style="width: 35px;">@vm.CurrentCpuUsage%</span>
                                </div>
                                
                                <div class="d-flex align-items-center mb-2">
                                    <span class="small text-muted-light me-2" style="width: 30px;">GPU</span>
                                    <div class="progress flex-grow-1" style="height: 4px; background-color: #333;">
                                        <div class="progress-bar bg-success" style="width: @vm.CurrentGpuUsage%"></div>
                                    </div>
                                    <span class="small ms-2 text-white" style="width: 35px;">@vm.CurrentGpuUsage%</span>
                                </div>

                                <div class="d-flex align-items-center">
                                    <span class="small text-muted-light me-2" style="width: 30px;">RAM</span>
                                    <div class="progress flex-grow-1" style="height: 4px; background-color: #333;">
                                        <div class="progress-bar" style="width: @vm.CurrentRamUsage%; background-color: #a855f7;"></div>
                                    </div>
                                    <span class="small ms-2 text-white" style="width: 35px;">@vm.CurrentRamUsage%</span>
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-white">@vm.CurrentSessionCost.ToString("C")</div>
                                <div class="small text-muted-light">@vm.CostPerHour.ToString("C")/hr</div>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm @(vm.Status == "Running" ? "btn-outline-danger" : "btn-outline-success")" 
                                        @onclick="() => ToggleVm(vm)">
                                    @(vm.Status == "Running" ? "Stop" : "Start")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private List<VirtualMachine> Vms { get; set; } = new();
    private PeriodicTimer? _timer;
    private CancellationTokenSource _cts = new();

    // New Fields for Slider Binding
    private double CpuLimit { get; set; } = 55;
    private double RamLimit { get; set; } = 80;

    protected override async Task OnInitializedAsync()
    {
        // 1. Load initial data
        await RefreshData();
        // 2. Start background timer
        _ = StartTimerAsync(); 
    }

    private async Task StartTimerAsync()
    {
        // Ticks every 100ms for smooth updates
        _timer = new PeriodicTimer(TimeSpan.FromMilliseconds(500)); // Changed to 500ms for reasonable load

        try
        {
            while (await _timer.WaitForNextTickAsync(_cts.Token))
            {
                await RefreshData();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException) { }
    }

    private async Task RefreshData()
    {
        Vms = await VmService.GetMyVmsAsync();
    }

    private void ToggleVm(VirtualMachine vm)
    {
        if (vm.Status == "Running")
        {
            vm.Status = "Stopped";
            vm.CurrentCpuUsage = 0;
            vm.CurrentGpuUsage = 0;
            vm.CurrentRamUsage = 0;
        }
        else
        {
            vm.Status = "Running";
            vm.CurrentCpuUsage = 10;
            vm.CurrentRamUsage = 20;
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _timer?.Dispose();
        _cts.Dispose();
    }
}